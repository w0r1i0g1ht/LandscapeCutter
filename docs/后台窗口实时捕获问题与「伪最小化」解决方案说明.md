后台窗口实时捕获问题与「伪最小化」解决方案说明
1. 问题背景

本项目旨在实现一种类似“风景刀”的桌面工具：
允许用户从任意应用窗口中裁切出一个实时更新的区域，并将其作为桌面置顶浮窗显示。

在实际实现过程中，发现了一个典型问题：

当目标应用窗口被最小化后，浮窗中的画面将不再实时更新；
只有当目标窗口重新显示到前台时，画面才会同步变化。

该问题在 QQ、浏览器、Electron / Qt 应用等场景中普遍存在。

2. 问题现象描述

具体表现为：

用户选取目标应用（如 QQ）的某个区域作为浮窗内容；

当目标窗口处于前台或可见状态时，浮窗画面可以实时刷新；

用户将目标窗口最小化：

目标应用内部仍在运行；

但浮窗画面停留在最小化前的最后一帧；

只有当目标窗口再次被恢复显示时，浮窗画面才重新更新。

从用户体验角度看，这会被误认为是“捕获失败”或“程序 Bug”。

3. 根本原因分析

该现象并非程序逻辑错误，而是由 Windows 图形系统的设计机制决定。

3.1 Windows 对最小化窗口的处理机制

在 Windows 中：

当窗口被最小化（WS_MINIMIZE）或完全不可见时；

系统通常 不再持续对该窗口进行绘制；

DWM（Desktop Window Manager）不会生成新的合成帧；

GPU Back Buffer 内容保持在最后一次可见状态。

因此：

对最小化窗口进行截图或窗口捕获，只能得到静态画面。

3.2 常见窗口捕获方式的共同限制

无论使用以下哪种方式：

GDI（BitBlt / PrintWindow）

DXGI Desktop Duplication

DWM 合成结果捕获

都依赖于 窗口当前是否被系统持续渲染。

一旦窗口被最小化，实时更新便无法保证。

4. 设计目标与取舍原则

在本项目中，明确采用以下设计原则：

✅ 不侵入目标应用进程

✅ 不 Hook / 注入渲染管线

✅ 不破坏应用原有行为

✅ 以稳定性和可维护性为优先

❌ 不对抗 Windows 图形系统机制

基于上述原则，本项目选择采用一种工程折中的“伪最小化”方案。

5. 解决思路概述：伪最小化窗口
5.1 核心思想

不让 Windows 认为窗口“被最小化”，
而是让窗口“对用户不可见，但对系统仍然可渲染”。

只要窗口在系统层面仍处于 NORMAL 状态，
Windows 就会持续为其生成绘制内容，捕获也就可以实时进行。

6. 具体方案：移出屏幕的伪最小化设计
6.1 方案描述

当用户希望“后台运行并持续捕获”目标窗口时：

程序不调用 ShowWindow(SW_MINIMIZE)

而是将目标窗口整体移动到屏幕可视区域之外

从用户角度看，窗口“消失了”；
从系统角度看，窗口仍然存在并持续渲染。

6.2 技术实现细节
1）保存窗口原始状态

在执行伪最小化前，程序会记录：

窗口位置（x, y）

窗口尺寸（width, height）

用于后续恢复。

2）将窗口移出屏幕

通过 Win32 API 调整窗口位置：

SetWindowPos(
    hwnd,
    nullptr,
    -10000, -10000,      // 屏幕外坐标
    width, height,
    SWP_NOZORDER | SWP_NOACTIVATE
);


关键点说明：

不改变窗口大小（避免触发异常重绘逻辑）

不修改 Z-Order

不抢占焦点

不触发最小化状态

3）恢复窗口显示

当用户需要重新操作目标应用时：

SetWindowPos(
    hwnd,
    nullptr,
    old_x, old_y,
    old_w, old_h,
    SWP_NOZORDER
);


窗口将恢复到原始位置和尺寸。

6.3 状态管理设计

程序内部维护简单的窗口状态：

NORMAL：窗口正常显示

PSEUDO_MINIMIZED：窗口已被移出屏幕

所有捕获逻辑仅在窗口处于上述两种状态时运行，
而不会处理真实的系统最小化状态。

7. 用户操作与体验效果
7.1 用户视角的操作流程

用户选择一个应用窗口；

裁切所需的捕获区域；

点击工具中的 “固定并后台运行” 按钮；

目标窗口从桌面上消失；

桌面浮窗持续显示该窗口区域的实时画面；

用户可随时点击 “恢复窗口” 按钮重新显示原窗口。

7.2 用户体验效果

✅ 浮窗画面持续实时更新

✅ 不受窗口遮挡或后台运行影响

✅ 不干扰用户当前的其他工作

✅ 行为可预期、无“黑魔法”副作用

8. 已知限制与说明

若用户手动最小化目标窗口（真实最小化），仍可能导致捕获暂停；

本项目不尝试拦截或修改目标应用的系统菜单行为；

该方案属于工程折中，而非系统级解决方案。

这些限制均已在文档中明确说明。

9. 总结

后台最小化窗口无法实时捕获是 Windows 系统的自然行为；

本项目通过“移出屏幕”的伪最小化方式，保持窗口可渲染状态；

在稳定性、实现成本和用户体验之间取得了合理平衡；

该设计符合轻量级开源桌面工具的工程定位。